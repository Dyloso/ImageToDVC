<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Image to DVC Village Converter</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    input[type="file"] {
      margin: 20px 0;
    }
    canvas {
      border: 1px solid #000;
    }
    .slider-container {
      margin: 20px 0;
    }
    .slider-label {
      display: block;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>

  <h1>Image to DVC Village Converter</h1>
  <h4>Please use images close in resolution to desired size for best results.</h4>
  <input type="file" id="fileInput" accept="image/*" />

  <div class="slider-container">
    <label for="resolutionSlider" class="slider-label">Output Resolution: <span id="resolutionValue">80</span>x<span id="resolutionValueY">80</span></label>
    <input type="range" id="resolutionSlider" min="0" max="8" step="1">
  </div>

  <canvas id="canvas"></canvas>

  <script>
  const PRESET_COLORS = [
    [140, 27, 33], [254, 4, 93], [233, 69, 129], [230, 106, 114],
    [241, 175, 179], [203, 66, 33], [242, 88, 52], [250, 135, 51],
    [252, 168, 80], [242, 242, 242], [232, 178, 44], [254, 207, 91],
    [254, 207, 115], [254, 238, 204], [221, 239, 251], [104, 146, 122],
    [150, 170, 117], [101, 206, 120], [165, 223, 72], [182, 181, 195],
    [64, 223, 255], [167, 198, 255], [143, 228, 209], [185, 241, 254],
    [204, 204, 204], [129, 89, 201], [163, 165, 224], [214, 132, 242],
    [229, 196, 239], [170, 170, 170], [96, 73, 57], [177, 119, 105],
    [164, 132, 111], [231, 214, 206], [186, 185, 190], [63, 96, 127],
    [91, 120, 150], [156, 178, 199], [206, 222, 237], [171, 160, 154],
    [64, 64, 64], [95, 100, 119], [121, 133, 149], [179, 187, 198],
    [136, 136, 136], [94, 94, 94], [119, 119, 119]
  ];

  const TILE_SIZE = 29;
  const tileImages = [];
  let originalImage = null;
  let resolutionOptions = [15, 20, 30, 40, 50, 60, 70, 80, 'original'];
  let selectedResolution = 80;

  function preloadTiles(callback) {
    let loaded = 0;
    for (let i = 0; i < 47; i++) {
      const img = new Image();
      img.src = `tile_${i}.png`;
      img.onload = () => {
        tileImages[i] = img;
        loaded++;
        if (loaded === 47) callback();
      };
      img.onerror = () => console.error(`Failed to load tile_${i}.png`);
    }
  }

  function getColorIndex(rgb) {
    let minDistance = Infinity;
    let closestIndex = 0;
    for (let i = 0; i < PRESET_COLORS.length; i++) {
      let color = PRESET_COLORS[i];
      let dist =
        (rgb[0] - color[0]) ** 2 +
        (rgb[1] - color[1]) ** 2 +
        (rgb[2] - color[2]) ** 2;
      if (dist < minDistance) {
        minDistance = dist;
        closestIndex = i;
      }
    }
    return closestIndex;
  }

  function drawWithTiles(imageData, ctx, width, height) {
    for (let y = 0; y < height; y++) {
      for (let x = 0; x < width; x++) {
        const i = (y * width + x) * 4;
        const r = imageData.data[i];
        const g = imageData.data[i + 1];
        const b = imageData.data[i + 2];

        const tileIndex = getColorIndex([r, g, b]);
        const tile = tileImages[tileIndex];
        ctx.drawImage(tile, x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
      }
    }
  }

  function resizeAndDrawImage() {
    if (!originalImage) return;

    const TARGET_WIDTH = selectedResolution === 'original' ? originalImage.width : selectedResolution;
    const TARGET_HEIGHT = selectedResolution === 'original' ? originalImage.height : selectedResolution;

    let srcCanvas = document.createElement("canvas");
    let srcCtx = srcCanvas.getContext("2d");
    srcCanvas.width = originalImage.width;
    srcCanvas.height = originalImage.height;
    srcCtx.drawImage(originalImage, 0, 0);

    let currentCanvas = srcCanvas;
    while (currentCanvas.width > TARGET_WIDTH * 2 || currentCanvas.height > TARGET_HEIGHT * 2) {
      let nextWidth = Math.max(TARGET_WIDTH, Math.floor(currentCanvas.width / 2));
      let nextHeight = Math.max(TARGET_HEIGHT, Math.floor(currentCanvas.height / 2));
      let tmpCanvas = document.createElement("canvas");
      tmpCanvas.width = nextWidth;
      tmpCanvas.height = nextHeight;
      let tmpCtx = tmpCanvas.getContext("2d");
      tmpCtx.imageSmoothingEnabled = true;
      tmpCtx.imageSmoothingQuality = "high";
      tmpCtx.drawImage(currentCanvas, 0, 0, currentCanvas.width, currentCanvas.height, 0, 0, nextWidth, nextHeight);
      currentCanvas = tmpCanvas;
    }

    const tempCanvas = document.createElement("canvas");
    tempCanvas.width = TARGET_WIDTH;
    tempCanvas.height = TARGET_HEIGHT;
    const tempCtx = tempCanvas.getContext("2d");
    tempCtx.imageSmoothingEnabled = true;
    tempCtx.imageSmoothingQuality = "high";
    tempCtx.drawImage(currentCanvas, 0, 0, currentCanvas.width, currentCanvas.height, 0, 0, TARGET_WIDTH, TARGET_HEIGHT);

    const resizedImageData = tempCtx.getImageData(0, 0, TARGET_WIDTH, TARGET_HEIGHT);

    const canvas = document.getElementById("canvas");
    canvas.width = TARGET_WIDTH * TILE_SIZE;
    canvas.height = TARGET_HEIGHT * TILE_SIZE;
    const ctx = canvas.getContext("2d");

    preloadTiles(() => {
      drawWithTiles(resizedImageData, ctx, TARGET_WIDTH, TARGET_HEIGHT);
    });
  }

  document.getElementById("fileInput").addEventListener("change", function (event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function (e) {
      const img = new Image();
      img.onload = function () {
        originalImage = img;
        resizeAndDrawImage();
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  });

  document.getElementById("resolutionSlider").addEventListener("input", function (e) {
    const value = parseInt(e.target.value);
    selectedResolution = resolutionOptions[value];
    document.getElementById("resolutionValue").textContent = selectedResolution === 'original' ? originalImage.width : selectedResolution;
    document.getElementById("resolutionValueY").textContent = selectedResolution === 'original' ? originalImage.height : selectedResolution;
    resizeAndDrawImage();
  });
  </script>
</body>
</html>